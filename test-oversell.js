/**
 * GENERATED BY AI
 * Oversell Prevention Test
 * Try to reserve more seats than available concurrently
 */

const BASE_URL = "http://localhost:3000";

const reserveSeats = async (partnerId, seats) => {
  const res = await fetch(`${BASE_URL}/reservations`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ partnerId, seats }),
  });
  return { partnerId, status: res.status, data: await res.json() };
};

const getEventSummary = async () => {
  const res = await fetch(`${BASE_URL}/reservations`);
  return res.json();
};

const runOversellTest = async () => {
  console.log("=== OVERSELL PREVENTION TEST ===\n");

  const before = await getEventSummary();
  const available = before.availableSeats;

  console.log(`Available seats: ${available}`);

  // Try to reserve MORE than available with concurrent requests
  // 60 partners * 10 seats = 600 seats (but only 500 available)
  const numPartners = 60;
  const seatsEach = 10;

  console.log(`Attempting: ${numPartners} partners x ${seatsEach} seats = ${numPartners * seatsEach} seats`);
  console.log(`This exceeds available seats - some MUST fail!\n`);

  const promises = [];
  for (let i = 1; i <= numPartners; i++) {
    promises.push(reserveSeats(`partner-${i}`, seatsEach));
  }

  const results = await Promise.all(promises);

  const successful = results.filter((r) => r.status === 201);
  const conflicts = results.filter((r) => r.status === 409);

  console.log(`Successful: ${successful.length}`);
  console.log(`Rejected (409): ${conflicts.length}`);

  const after = await getEventSummary();
  console.log(`\nFinal available seats: ${after.availableSeats}`);
  console.log(`Total reservations: ${after.reservationCount}`);

  // Critical check
  if (after.availableSeats >= 0) {
    console.log("\n✅ PASS: No overselling! Available seats never went negative.");
  } else {
    console.log("\n❌ FAIL: OVERSOLD! Available seats is negative!");
  }

  // Math check
  const maxPossible = Math.floor(available / seatsEach);
  console.log(`\nMax possible reservations: ${maxPossible}`);
  console.log(`Actual reservations: ${successful.length}`);

  if (successful.length <= maxPossible) {
    console.log("✅ PASS: Did not exceed maximum possible reservations.");
  }
};

runOversellTest().catch(console.error);